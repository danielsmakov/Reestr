@{
    ViewBag.Title = "Реестр услуг оказываемых организацией";
}
@model List<Reestr.BLL.DTOs.ServiceReestrDTO>
@using Kendo.Mvc.UI


<div>
    <div class="k-content">
        <h2>ServiceReestr</h2>
        <div id="grid"></div>
        <div id="popupWindow"></div>
        <div id="deleteConfirmationPopup">
            <p><b>Вы уверены, что хотите удалить эту запись?</b></p>
            <button class="button-success">Подтвердить</button>
            <button class="button-success">Отмена</button>
        </div>
    </div>

    <script type="text/x-template" id="toolbar">
        <button id="addButton" class="k-button"><span class="k-icon k-i-plus"></span>Добавить</button>

        <input type="text" name="organizationSearch" id="organizationSearch" class="k-textbox" placeholder="Поиск организации..." style="width: 280px; margin-left: 15px" />
        <input type="text" name="serviceSearch" id="serviceSearch" class="k-textbox" placeholder="Поиск услуги..." style="width: 280px; margin-left: 15px" />
        <button id="searchButton" class="k-button" style="width: 60px">Поиск</button>

        <label for="isdeleted" style="margin-left: 30px">Искать удаленные записи?</label>
        <input type="checkbox" name="isdeleted" id="isdeleted" class="k-checkbox" />
    </script>

    <script type="text/x-template" id="deleteButtonTemplate">
        <button class="k-button k-delete" style="margin-left: -4px">Удалить</button>
    </script>

    <script type="text/javascript">

        $(document).ready(function () {



            var dataSource = new kendo.data.DataSource({
                type: "odata",
                transport: {
                    read: {
                        url: "/ServiceReestr/List",
                        data: function (data) {
                            return {
                                data
                            }
                        },
                        type: "GET",
                        dataType: "json",
                    },
                    create: {
                        url: "/ServiceReestr/Insert",
                        type: "POST",
                        dataType: "json",
                    },
                    update: {
                        url: "/ServiceReestr/Update",
                        type: "POST",
                        dataType: "json"
                    },
                    destroy: {
                        url: "/ServiceReestr/Delete",
                        type: "POST",
                        dataType: "json"
                    },
                    parameterMap: function (data, type) {
                        if (type == "destroy") {
                            return { Id: kendo.stringify(data.Id) };
                        }
                        if (type == "update") {
                            return kendo.stringify(data);
                        }
                        if (type == "create") {
                            return kendo.stringify(data);
                        }
                        if (type == "read") {
                            return {
                                Offset: $('#grid').data('kendoGrid').dataSource.skip(),
                                Limit: $('#grid').data('kendoGrid').dataSource.pageSize(),
                                SortingParameters: data.sort,
                                OrganizationNameToSearchFor: $("#organizationSearch").val(),
                                IsDeleted: document.getElementById('isdeleted').checked
                            }
                        }
                    },
                },
                pageSize: 20,
                serverPaging: true,
                serverSorting: true,
                schema: {
                    data: "Data",
                    total: "Total",
                    model: {
                        id: "Id",
                        fields: {
                            Id: { type: "number", editable: false, nullable: true },
                            Organization: [{ Name: { type: "string" } }],
                            Service: [{ Name: { type: "string" } }],
                            Price: { type: "number", validation: { required: true } },
                            BeginDate: { type: "date", validation: { required: true } }
                        }
                    }
                }
            });



            $("#grid").kendoGrid({
                dataSource: dataSource,
                pageable: true,
                height: 550,
                sortable: true,
                toolbar: [{ template: kendo.template($("#toolbar").html()) }],
                search: {
                    fields: ["Name"],
                },
                columns: [
                    { field: "Organization.Name", title: "Организация", width: 450 },
                    { field: "Service.Name", title: "Услуга", width: 120 },
                    { field: "Price", title: "Стоимость", width: 120 },
                    { field: "BeginDate", title: "Дата начала действия", format: "{0:dd/MM/yyyy}", width: 120 },
                    {
                        command: [
                            { name: "edit", text: "Редактировать" },
                            { template: kendo.template($('#deleteButtonTemplate').html()) }
                        ], width: 170
                    }],
                editable: {
                    mode: false,
                    confirmation: false,
                    window: { title: "" },
                },
                edit: function (e) {
                    var update = $(e.container).parent().find(".k-grid-update");
                    var cancel = $(e.container).parent().find(".k-grid-cancel");
                    $(update).html('<span class="k-update">Подтвердить</span>');
                    $(cancel).html('<span class="k-cancel">Отмена</span>');
                    $('#BIN').kendoMaskedTextBox({
                        mask: '0000-0000-0000'
                    })
                    $('#PhoneNumber').kendoMaskedTextBox({
                        mask: '(000)-000-0000'
                    });
                },
            }).data("kendoGrid");

            


            @*$("body").on("keyup", "#organizationSearch", function () {
                var value = $("#organizationSearch").val();
                if (value.length == 0) {
                    $("#grid").data("kendoGrid").refresh();
                }
            });
            $("body").on("keyup", "#serviceSearch", function () {
                var value = $("#serviceSearch").val();
                if (value.length == 0) {
                    $("#grid").data("kendoGrid").refresh();
                }
            });
            $("body").on("click", "#searchButton", function () {
                var organizationSearchValue = $("#organizationSearch").val();
                var serviceSearchValue = $("#serviceSearch").val();
                if (organizationSearchValue.length == 0 && serviceSearchValue.length == 0) {
                    $("#grid").data("kendoGrid").refresh();
                }
                if (serviceSearchValue.length == 0 && organizationSearchValue.length !== 0) {
                    if (organizationSearchValue.length < 3 && organizationSearchValue.length > 0) {
                        return
                    }
                    else {
                        $("#grid").data("kendoGrid").dataSource.filter({
                            logic: "or",
                            filters: [
                                { field: "Organization", operator: "contains", value: organizationSearchValue }
                            ],
                        });
                        $("#grid").data("kendoGrid").dataSource.read();
                    }
                }
                else {
                    if (serviceSearchValue.length < 3 && serviceSearchValue.length > 0) {
                        return
                    }
                    else {
                        $("#grid").data("kendoGrid").dataSource.filter({
                            logic: "or",
                            filters: [
                                { field: "Service", operator: "contains", value: serviceSearchValue }
                            ],
                        });
                        $("#grid").data("kendoGrid").dataSource.read();
                    }
                }
            });*@



            // Displaying deleted/not deleted records
            $("body").on("click", "#isdeleted", function () {
                if (document.getElementById('isdeleted').click) {
                    var value = $("#isdeleted").val();

                    $("#grid").data("kendoGrid").dataSource.filter({
                        logic: "or",
                        filters: [
                            { field: "EndDate" }
                        ]
                    });
                    $("#grid").data("kendoGrid").dataSource.read();
                }

            });



            // Adding record
            var popupWindow = $('#popupWindow'),
                addButton = $('#addButton');

            addButton.click(function () {

                popupWindow.kendoWindow({
                    width: "300px",
                    height: "500px",
                    title: "Добавление/Редактирование",
                    visible: false,
                    draggable: false,
                    actions: [
                        "Close"
                    ],
                    content: "/ServiceReestr/Edit/"
                }).data('kendoWindow');

                popupWindow.data('kendoWindow').center().open();
            });



            // Editing record
            $('#grid').on('click', '.k-grid-edit', function () {
                var grid = $('#grid').data('kendoGrid');
                var model = grid.dataItem($(this).closest('tr'));

                popupWindow.kendoWindow({
                    width: "300px",
                    height: "500px",
                    title: "Добавление/Редактирование",
                    visible: false,
                    draggable: false,
                    actions: [
                        "Close"
                    ],
                    content: "/ServiceReestr/Edit/" + model.Id
                }).data('kendoWindow');

                popupWindow.data('kendoWindow').center().open();
            })



            // Deleting record
            var popup = $('#deleteConfirmationPopup');

            $('#grid').on('click', '.k-delete', function () {
                popup.kendoWindow({
                    width: "300px",
                    height: "150px",
                    title: "Подтверждение удаления",
                    visible: false,
                    draggable: false,
                    actions: ["Close"]
                }).data('kendoWindow');

                popup.data('kendoWindow').center().open();
            });




            @*$('#grid').on('click', '.k-grid-delete', function () {
                

                

                var model = grid.dataItem($(this).closest('tr'));
                $.ajax({
                    url: "/ServiceReestr/Delete/" + model.Id,
                    data: model.Id,
                    type: "POST",
                    dataType: "json",
                })
            })*@
            
        })

    </script>

</div>